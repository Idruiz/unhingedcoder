<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Unhinged Codex – GPT Code Firehose</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #f5f5f7;
        --panel-bg: #ffffff;
        --border: #d0d7de;
        --accent: #2563eb;
        --accent-soft: rgba(37, 99, 235, 0.08);
        --accent-strong: #1d4ed8;
        --text: #111827;
        --muted: #6b7280;
        --danger: #b91c1c;
        --code-bg: #020617;
        --code-text: #e5e7eb;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      .app-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        background: #ffffff;
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 16px;
      }

      header h1 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
      }

      header span {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .session-pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent-strong);
        font-size: 0.75rem;
      }

      main {
        flex: 1;
        padding: 16px 24px 24px;
        display: grid;
        grid-template-columns: minmax(260px, 340px) minmax(0, 1fr);
        gap: 16px;
        min-height: 0;
      }

      .panel {
        background: var(--panel-bg);
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 0;
      }

      .panel h2 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
      }

      label {
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--muted);
        display: block;
        margin-bottom: 4px;
      }

      textarea {
        width: 100%;
        min-height: 140px;
        resize: vertical;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid var(--border);
        font-family: inherit;
        font-size: 0.9rem;
      }

      textarea:focus {
        outline: 2px solid var(--accent-soft);
        border-color: var(--accent);
      }

      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 4px;
      }

      button {
        border-radius: 999px;
        border: 1px solid transparent;
        padding: 7px 14px;
        font-size: 0.82rem;
        font-weight: 500;
        cursor: pointer;
        background: var(--accent);
        color: #ffffff;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      button.secondary {
        background: #ffffff;
        color: var(--text);
        border-color: var(--border);
      }

      button.secondary:hover {
        border-color: var(--accent);
      }

      button.danger {
        background: var(--danger);
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .left-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
      }

      .file-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
      }

      input[type="file"] {
        font-size: 0.8rem;
      }

      .status {
        font-size: 0.78rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .status.error {
        color: var(--danger);
      }

      .output-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .output-header-meta {
        font-size: 0.78rem;
        color: var(--muted);
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .output-header-meta button {
        font-size: 0.75rem;
        padding: 5px 10px;
      }

      .output-container {
        flex: 1;
        min-height: 0;
        border-radius: 10px;
        background: var(--code-bg);
        color: var(--code-text);
        padding: 10px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.78rem;
        overflow: auto; /* scroll inside the frame */
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .code-block {
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        overflow: hidden;
      }

      .code-block-header {
        background: rgba(15, 23, 42, 0.9);
        padding: 6px 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        font-size: 0.78rem;
      }

      .code-block-title {
        color: #e5e7eb;
        font-weight: 500;
      }

      .code-block-header button {
        background: transparent;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.8);
        color: #e5e7eb;
        padding: 3px 9px;
        font-size: 0.72rem;
      }

      .code-block-body {
        padding: 10px;
        background: #020617;
        color: #e5e7eb;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .output-empty {
        opacity: 0.7;
      }

      footer {
        padding: 10px 24px 16px;
        font-size: 0.8rem;
        color: var(--muted);
        text-align: center;
      }

      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header>
        <div>
          <h1>Unhinged Codex</h1>
          <span>GPT-style code firehose · chat + refactor</span>
        </div>
        <div class="session-pill" id="session-pill">
          Local session · ID pending…
        </div>
      </header>

      <main>
        <!-- LEFT: INPUTS -->
        <div class="left-section">
          <section class="panel">
            <h2>Prompt to Codex</h2>
            <label for="prompt-input">
              Describe the monstrosity of a codebase you want, or the change
              you need.
            </label>
            <textarea
              id="prompt-input"
              placeholder="Example: Build a complete multi-file Google Apps Script + HTML deployment pipeline for a Render-hosted webapp that..."
            ></textarea>

            <div class="button-row">
              <button id="generate-btn">Generate Code</button>
              <button
                id="open-architect-btn"
                type="button"
                class="secondary"
              >
                Open Prompt Architect
              </button>
              <button id="clear-output-btn" type="button" class="secondary">
                Clear Output
              </button>
            </div>

            <div id="chat-status" class="status">Idle.</div>
          </section>

          <section class="panel">
            <h2>Upload code for review / refactor</h2>
            <div class="file-row">
              <input id="file-input" type="file" />
            </div>

            <label for="refactor-notes">
              Optional instructions for the refactor
            </label>
            <textarea
              id="refactor-notes"
              rows="4"
              placeholder="Example: Break into modules, add screaming unit tests, modernize syntax, and harden error handling."
            ></textarea>

            <div class="button-row">
              <button id="refactor-btn">Send for Refactor</button>
            </div>

            <div id="upload-status" class="status">Idle.</div>
          </section>
        </div>

        <!-- RIGHT: OUTPUT -->
        <section class="panel">
          <div class="output-header">
            <h2>Model Output</h2>
            <div class="output-header-meta">
              <span>Model: <span id="model-used">—</span></span>
              <span>Fallback: <span id="fallback-used">—</span></span>
              <button id="copy-all-btn" type="button" class="secondary">
                Copy All
              </button>
            </div>
          </div>

          <div id="output-container" class="output-container">
            <div class="output-empty">// Code will appear here...</div>
          </div>
        </section>
      </main>

      <footer>
        Unhinged Codex runs on your Render service. Your API key never touches
        the browser — all OpenAI calls go through your Node backend.
      </footer>
    </div>

    <script>
      // -------------------------------------------------------------------
      // SESSION HANDLING
      // -------------------------------------------------------------------
      const SESSION_STORAGE_KEY = "unhinged-codex-session-id";

      function createSessionId() {
        if (window.crypto && crypto.randomUUID) {
          return crypto.randomUUID();
        }
        return (
          "session-" +
          Date.now() +
          "-" +
          Math.random().toString(16).slice(2)
        );
      }

      let sessionId =
        localStorage.getItem(SESSION_STORAGE_KEY) || createSessionId();
      localStorage.setItem(SESSION_STORAGE_KEY, sessionId);

      const sessionPill = document.getElementById("session-pill");
      if (sessionPill) {
        sessionPill.textContent =
          "Local session · " + sessionId.slice(0, 8) + "…";
      }

      // -------------------------------------------------------------------
      // ELEMENTS
      // -------------------------------------------------------------------
      const promptInput = document.getElementById("prompt-input");
      const generateBtn = document.getElementById("generate-btn");
      const architectBtn = document.getElementById("open-architect-btn");
      const clearBtn = document.getElementById("clear-output-btn");
      const fileInput = document.getElementById("file-input");
      const refactorNotes = document.getElementById("refactor-notes");
      const refactorBtn = document.getElementById("refactor-btn");
      const chatStatus = document.getElementById("chat-status");
      const uploadStatus = document.getElementById("upload-status");
      const outputContainer = document.getElementById("output-container");
      const modelLabel = document.getElementById("model-used");
      const fallbackLabel = document.getElementById("fallback-used");
      const copyAllBtn = document.getElementById("copy-all-btn");

      function setChatStatus(msg, isError = false) {
        chatStatus.textContent = msg;
        chatStatus.classList.toggle("error", isError);
      }

      function setUploadStatus(msg, isError = false) {
        uploadStatus.textContent = msg;
        uploadStatus.classList.toggle("error", isError);
      }

      // -------------------------------------------------------------------
      // OUTPUT RENDERING + COPY
      // -------------------------------------------------------------------
      let lastAssistantText = "";

      function splitIntoBlocks(text) {
        const lines = text.split(/\r?\n/);
        const blocks = [];
        const headerRe = /^\s*\/\/\s*file:\s*(.+)$/i;

        let current = { title: "Full output", lines: [] };
        for (const line of lines) {
          const m = line.match(headerRe);
          if (m) {
            if (current.lines.length > 0) {
              blocks.push({
                title: current.title,
                content: current.lines.join("\n"),
              });
            }
            current = { title: m[1].trim(), lines: [] };
          } else {
            current.lines.push(line);
          }
        }
        if (current.lines.length > 0) {
          blocks.push({
            title: current.title,
            content: current.lines.join("\n"),
          });
        }

        // If there's only one block and no explicit file header,
        // just label it "Full output".
        if (blocks.length === 1 && blocks[0].title === "Full output") {
          return blocks;
        }
        return blocks;
      }

      function renderOutput(text) {
        lastAssistantText = text || "";
        outputContainer.innerHTML = "";

        if (!text || !text.trim()) {
          const empty = document.createElement("div");
          empty.className = "output-empty";
          empty.textContent = "// (empty response from model)";
          outputContainer.appendChild(empty);
          return;
        }

        const blocks = splitIntoBlocks(text);

        blocks.forEach((block, index) => {
          const wrapper = document.createElement("div");
          wrapper.className = "code-block";

          const header = document.createElement("div");
          header.className = "code-block-header";

          const title = document.createElement("div");
          title.className = "code-block-title";
          title.textContent =
            blocks.length === 1
              ? "Full output"
              : block.title || `Chunk ${index + 1}`;

          const copyBtn = document.createElement("button");
          copyBtn.type = "button";
          copyBtn.textContent = "Copy";
          copyBtn.addEventListener("click", () => {
            navigator.clipboard
              .writeText(block.content)
              .then(() => setChatStatus("Copied block to clipboard."))
              .catch((err) => {
                console.error("Clipboard error:", err);
                setChatStatus("Clipboard error (see console).", true);
              });
          });

          header.appendChild(title);
          header.appendChild(copyBtn);

          const body = document.createElement("div");
          body.className = "code-block-body";
          body.textContent = block.content || "";

          wrapper.appendChild(header);
          wrapper.appendChild(body);
          outputContainer.appendChild(wrapper);
        });
      }

      copyAllBtn.addEventListener("click", () => {
        if (!lastAssistantText || !lastAssistantText.trim()) {
          setChatStatus("Nothing to copy yet.", true);
          return;
        }
        navigator.clipboard
          .writeText(lastAssistantText)
          .then(() => setChatStatus("Copied ALL output to clipboard."))
          .catch((err) => {
            console.error("Clipboard error:", err);
            setChatStatus("Clipboard error (see console).", true);
          });
      });

      // -------------------------------------------------------------------
      // APPLY RESULT FROM BACKEND
      // -------------------------------------------------------------------
      function applyResultToUI(data) {
        if (!data) return;
        if (data.sessionId) {
          sessionId = data.sessionId;
          localStorage.setItem(SESSION_STORAGE_KEY, sessionId);
          sessionPill.textContent =
            "Local session · " + sessionId.slice(0, 8) + "…";
        }

        renderOutput(data.assistantText || "");

        modelLabel.textContent = data.modelUsed || "—";
        fallbackLabel.textContent = data.fromFallback ? "yes" : "no";
      }

      async function callBackend(path, body, setStatusFn) {
        setStatusFn("Contacting backend…");

        try {
          const res = await fetch(path, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          let payload = null;
          try {
            payload = await res.json();
          } catch (e) {
            // ignore parse error
          }

          if (!res.ok) {
            const message =
              (payload && payload.error) ||
              `${res.status} ${res.statusText || ""}`.trim();
            console.error("Backend error:", message, payload);
            setStatusFn("Error: " + message, true);
            return null;
          }

          setStatusFn("Done.");
          return payload;
        } catch (err) {
          console.error("Network / JS error:", err);
          setStatusFn(
            "Network / JS error – open browser console for details.",
            true
          );
          return null;
        }
      }

      // -------------------------------------------------------------------
      // CHAT HANDLER
      // -------------------------------------------------------------------
      generateBtn.addEventListener("click", async () => {
        const text = (promptInput.value || "").trim();
        if (!text) {
          setChatStatus("Please type a prompt first.", true);
          return;
        }

        generateBtn.disabled = true;
        refactorBtn.disabled = true;

        const result = await callBackend(
          "/api/chat",
          { sessionId, message: text },
          setChatStatus
        );

        generateBtn.disabled = false;
        refactorBtn.disabled = false;

        if (result) {
          applyResultToUI(result);
        }
      });

      // Keyboard shortcut: Ctrl+Enter / Cmd+Enter to fire chat
      promptInput.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
          e.preventDefault();
          generateBtn.click();
        }
      });

      // -------------------------------------------------------------------
      // PROMPT ARCHITECT
      // -------------------------------------------------------------------
      architectBtn.addEventListener("click", () => {
        window.open("prompt-architect.html", "_blank", "noopener");
      });

      // -------------------------------------------------------------------
      // CLEAR OUTPUT
      // -------------------------------------------------------------------
      clearBtn.addEventListener("click", () => {
        lastAssistantText = "";
        outputContainer.innerHTML = "";
        const empty = document.createElement("div");
        empty.className = "output-empty";
        empty.textContent = "// Code will appear here...";
        outputContainer.appendChild(empty);
        modelLabel.textContent = "—";
        fallbackLabel.textContent = "—";
        setChatStatus("Idle.");
      });

      // -------------------------------------------------------------------
      // REFACTOR HANDLER
      // -------------------------------------------------------------------
      refactorBtn.addEventListener("click", () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          setUploadStatus("Choose a file first.", true);
          return;
        }

        refactorBtn.disabled = true;
        generateBtn.disabled = true;

        const reader = new FileReader();
        reader.onload = async (ev) => {
          const content = ev.target.result;

          const payload = {
            sessionId,
            fileName: file.name,
            fileType: file.type,
            fileSize: file.size,
            fileContent: typeof content === "string" ? content : "",
            instructions: refactorNotes.value || "",
          };

          const result = await callBackend(
            "/api/upload",
            payload,
            setUploadStatus
          );

          refactorBtn.disabled = false;
          generateBtn.disabled = false;

          if (result) {
            applyResultToUI(result);
          }
        };

        reader.onerror = () => {
          console.error("FileReader error:", reader.error);
          setUploadStatus("Failed to read file.", true);
          refactorBtn.disabled = false;
          generateBtn.disabled = false;
        };

        setUploadStatus("Reading file…");
        reader.readAsText(file);
      });
    </script>
  </body>
</html>
