<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Unhinged Codex – GPT-5.1 Code Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #f5f5f7;
        --panel: #ffffff;
        --border: #d0d0e0;
        --accent: #2563eb;
        --accent-soft: #e0ecff;
        --text-main: #111827;
        --text-muted: #6b7280;
        --error: #b91c1c;
        --radius-lg: 12px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: var(--bg);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 12px 20px;
        background: #ffffff;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      header h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }

      header span {
        font-size: 12px;
        color: var(--text-muted);
      }

      main {
        flex: 1;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
        padding: 10px 16px 14px;
        max-width: 1280px;
        width: 100%;
        margin: 0 auto;
      }

      .top-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .chip {
        padding: 4px 8px;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent);
        font-size: 11px;
      }

      .chat-panel {
        display: grid;
        grid-template-columns: minmax(260px, 360px) minmax(0, 1fr);
        gap: 10px;
        height: 100%;
        min-height: 0;
      }

      .input-column,
      .output-column {
        background: var(--panel);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        padding: 10px;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .input-column h2,
      .output-column h2 {
        margin: 0 0 6px;
        font-size: 13px;
        font-weight: 600;
      }

      textarea {
        width: 100%;
        resize: vertical;
        min-height: 120px;
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 8px;
        font-family: inherit;
        font-size: 13px;
      }

      textarea:focus {
        outline: 2px solid var(--accent-soft);
        border-color: var(--accent);
      }

      .button-row {
        display: flex;
        gap: 8px;
        margin-top: 6px;
        flex-wrap: wrap;
      }

      button {
        border-radius: 999px;
        border: 1px solid transparent;
        padding: 6px 14px;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--accent);
        color: #ffffff;
      }

      button.secondary {
        background: #ffffff;
        color: var(--text-main);
        border-color: var(--border);
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .status-line {
        margin-top: 4px;
        font-size: 11px;
        color: var(--text-muted);
      }

      .status-line.error {
        color: var(--error);
      }

      .output-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      .output-meta {
        font-size: 11px;
        color: var(--text-muted);
      }

      pre {
        flex: 1;
        margin: 6px 0 0;
        padding: 10px;
        border-radius: 8px;
        background: #0b1020;
        color: #e5e7eb;
        font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo,
          Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        overflow: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .upload-panel {
        margin-top: 6px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .upload-row {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }

      .upload-row input[type="file"] {
        font-size: 11px;
      }

      footer {
        padding: 6px 16px 10px;
        font-size: 11px;
        color: var(--text-muted);
        text-align: center;
      }

      @media (max-width: 900px) {
        .chat-panel {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Unhinged Codex</h1>
        <span>GPT-5.1 code firehose – chat + refactor</span>
      </div>
      <div class="chip">Local session · ID stored in this browser</div>
    </header>

    <main>
      <div class="top-row">
        <span class="status-line" id="globalStatus">
          Session ready. Describe the monstrosity of a codebase you want, or
          upload a file for refactor.
        </span>
      </div>

      <section class="chat-panel">
        <!-- LEFT: Prompt + Upload -->
        <div class="input-column">
          <h2>Prompt to Codex</h2>
          <textarea
            id="promptInput"
            placeholder="Describe the app or codebase you want. Be specific about files, stack, structure, logging, tests, etc."
          ></textarea>

          <div class="button-row">
            <button id="sendBtn">Generate Code</button>
            <button
              class="secondary"
              type="button"
              onclick="openPromptArchitect()"
            >
              Open Prompt Architect
            </button>
            <button
              class="secondary"
              type="button"
              onclick="clearOutput()"
            >
              Clear Output
            </button>
          </div>

          <div class="upload-panel">
            <h2>Upload code for review / refactor</h2>
            <div class="upload-row">
              <input
                type="file"
                id="fileInput"
                title="Upload a code file (text-based works best)"
              />
              <button
                class="secondary"
                type="button"
                id="uploadBtn"
              >
                Send for Refactor
              </button>
            </div>
            <textarea
              id="uploadInstructions"
              placeholder="Optional: Tell Codex what you want from the refactor (e.g., break into modules, add unit tests, modernize syntax)."
              style="min-height: 70px"
            ></textarea>
          </div>

          <div
            class="status-line"
            id="requestStatus"
          >
            Idle.
          </div>
        </div>

        <!-- RIGHT: Giant code output -->
        <div class="output-column">
          <div class="output-header">
            <h2>Model Output</h2>
            <div class="output-meta" id="outputMeta">
              Model: — · Fallback: —
            </div>
          </div>
          <pre id="outputArea">// Code will appear here...</pre>
        </div>
      </section>

      <footer>
        Unhinged Codex runs on your Render service. No API keys are ever exposed
        to the browser; everything goes through your Node backend.
      </footer>
    </main>

    <script>
      const outputArea = document.getElementById("outputArea");
      const promptInput = document.getElementById("promptInput");
      const sendBtn = document.getElementById("sendBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const fileInput = document.getElementById("fileInput");
      const uploadInstructions = document.getElementById("uploadInstructions");
      const requestStatus = document.getElementById("requestStatus");
      const outputMeta = document.getElementById("outputMeta");
      const globalStatus = document.getElementById("globalStatus");

      let sessionId =
        window.localStorage.getItem("unhinged.sessionId") || null;

      function setLoading(isLoading, label) {
        if (isLoading) {
          requestStatus.textContent = label || "Working...";
          sendBtn.disabled = true;
          uploadBtn.disabled = true;
        } else {
          requestStatus.textContent = "Idle.";
          sendBtn.disabled = false;
          uploadBtn.disabled = false;
        }
      }

      function appendOutputBlock(prefix, text) {
        const sep = "\n\n// ------------------------------------------------------------\n";
        const block =
          sep +
          "// " +
          prefix +
          " @ " +
          new Date().toLocaleTimeString() +
          "\n\n" +
          text.trim() +
          "\n";
        outputArea.textContent =
          (outputArea.textContent || "").replace(
            "// Code will appear here...",
            ""
          ) + block;
        outputArea.scrollTop = outputArea.scrollHeight;
      }

      async function callChatAPI(message) {
        setLoading(true, "Generating code with GPT-5.1...");
        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ sessionId, message }),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || `HTTP ${res.status}`);
          }

          const data = await res.json();
          sessionId = data.sessionId || sessionId;
          if (sessionId) {
            window.localStorage.setItem("unhinged.sessionId", sessionId);
          }

          appendOutputBlock("CHAT COMPLETION", data.assistantText || "");
          outputMeta.textContent = `Model: ${data.modelUsed} · Fallback: ${
            data.fromFallback ? "yes" : "no"
          }`;
        } catch (err) {
          console.error("Chat error:", err);
          requestStatus.classList.add("error");
          requestStatus.textContent =
            "Error from /api/chat: " +
            (err?.message || "Unknown error. Check server logs on Render.");
        } finally {
          setLoading(false);
        }
      }

      async function callUploadAPI(file, instructions) {
        setLoading(true, "Sending file for refactor...");
        try {
          const text =
            (await file.text().catch(() => "")) || ""; // binary will be empty
          const res = await fetch("/api/upload", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              sessionId,
              fileName: file.name,
              fileType: file.type,
              fileSize: file.size,
              fileContent: text,
              instructions,
            }),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || `HTTP ${res.status}`);
          }

          const data = await res.json();
          sessionId = data.sessionId || sessionId;
          if (sessionId) {
            window.localStorage.setItem("unhinged.sessionId", sessionId);
          }

          appendOutputBlock(
            `UPLOAD REFRACTOR · ${file.name}`,
            data.assistantText || ""
          );
          outputMeta.textContent = `Model: ${data.modelUsed} · Fallback: ${
            data.fromFallback ? "yes" : "no"
          }`;
        } catch (err) {
          console.error("Upload error:", err);
          requestStatus.classList.add("error");
          requestStatus.textContent =
            "Error from /api/upload: " +
            (err?.message || "Unknown error. Check server logs on Render.");
        } finally {
          setLoading(false);
        }
      }

      sendBtn.addEventListener("click", () => {
        const msg = (promptInput.value || "").trim();
        requestStatus.classList.remove("error");

        if (!msg) {
          requestStatus.textContent = "Enter a prompt first.";
          return;
        }

        callChatAPI(msg);
      });

      promptInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          sendBtn.click();
        }
      });

      uploadBtn.addEventListener("click", () => {
        requestStatus.classList.remove("error");
        const file = fileInput.files?.[0];
        if (!file) {
          requestStatus.textContent = "Choose a file first.";
          return;
        }
        const instructions = uploadInstructions.value || "";
        callUploadAPI(file, instructions);
      });

      function clearOutput() {
        outputArea.textContent = "// Code will appear here...";
        outputMeta.textContent = "Model: — · Fallback: —";
      }

      function openPromptArchitect() {
        window.open(
          "/prompt-architect.html",
          "_blank",
          "noopener,noreferrer,width=1100,height=800"
        );
      }

      window.clearOutput = clearOutput;
      window.openPromptArchitect = openPromptArchitect;

      // Initial hint
      globalStatus.textContent =
        "Session ready. Describe the monstrosity of a codebase you want, or upload a file for refactor.";
    </script>
  </body>
</html>
